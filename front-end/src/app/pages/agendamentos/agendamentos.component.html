<div class="agendamentos">
  <div class="page-header">
    <h1>Agendamentos</h1>
    <button pButton icon="pi pi-plus" label="Novo Agendamento" (click)="showDialog('newAgendamento')">
    </button>
  </div>


  <p-tabs value="Agenda">
    <p-tablist>
      <p-tab value="Agenda">Agenda</p-tab>
      <p-tab value="Consultas">Consultas</p-tab>
      <p-tab value="Pacientes">Pacientes</p-tab>
    </p-tablist>


    <!-- ABA: AGENDA -->
    <p-tabpanel value="Agenda">
      <div class="tab-content">
        <div class="schedule-view">
          @for (schedule of schedules; track schedule.date) {
          <div class="schedule-day">
            <p-card [header]="(schedule.date | date:'fullDate') || ''" class="pt-2 pl-2" styleClass="day-card">
              <div class="agendamentos-list">
                @for (agendamento of schedule.agendamentos; track agendamento.id) {
                <div class="agendamento-item">
                  <div class="agendamento-time">{{ agendamento.time }}</div>
                  <div class="agendamento-details">
                    <strong>{{ agendamento.patientName }}</strong>
                    <span class="agendamento-type">{{ agendamento.type }}</span>
                    <span class="agendamento-doctor">{{ agendamento.doctor }}</span>
                  </div>
                  <div class="agendamento-actions">
                    <p-tag [value]="agendamento.status" [severity]="getSeverity(agendamento.status)"></p-tag>
                    <button pButton icon="pi pi-ellipsis-v" class="p-button-text"></button>
                  </div>
                </div>
                }

                @if (schedule.agendamentos.length === 0) {
                <div class="no-agendamentos">
                  Nenhum agendamento para esta data
                </div>
                }
              </div>
            </p-card>
          </div>
          }
        </div>
      </div>
    </p-tabpanel>

    <!-- ABA: CONSULTAS -->

      <p-dialog header="Consultas" [style]="{width: '500px'}" [(visible)]="visible" [modal]="true">
        <p-tabpanel value="Consultas">
          <div class="tab-content">
            <div class="filters">
              <div class="filter-group">
                <label>Status:</label>
                <p-select [options]="statusOptions" [(ngModel)]="statusFilter" optionLabel="label" optionValue="value"
                  [showClear]="true" placeholder="Filtrar por status">
                </p-select>
              </div>

              <div class="filter-group">
                <label>Data:</label>
                <p-datepicker [(ngModel)]="dateFilter" [showIcon]="true" dateFormat="dd/mm/yy" [showClear]="true"
                  placeholder="Filtrar por data">
                </p-datepicker>
              </div>

              <div class="filter-group">
                <label>Médico:</label>
                <p-select [options]="doctors" [(ngModel)]="doctorFilter" optionLabel="label" optionValue="value"
                  [showClear]="true" placeholder="Filtrar por médico">
                </p-select>
              </div>
            </div>

            <p-table [value]="getFilteredAgendamentos()" [tableStyle]="{'min-width': '60rem'}">
              <ng-template pTemplate="header">
                <tr>
                  <th>Paciente</th>
                  <th>Data/Hora</th>
                  <th>Tipo</th>
                  <th>Médico</th>
                  <th>Status</th>
                  <th>Ações</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-agendamento>
                <tr>
                  <td>
                    <strong>{{ agendamento.patientName }}</strong>
                    <br>
                    <small class="text-muted">ID: {{ agendamento.patientId }}</small>
                  </td>
                  <td>
                    {{ agendamento.date | date:'dd/MM/yyyy' }}
                    <br>
                    <small class="text-muted">{{ agendamento.time }}</small>
                  </td>
                  <td>{{ agendamento.type }}</td>
                  <td>{{ agendamento.doctor }}</td>
                  <td>
                    <p-tag [value]="agendamento.status" [severity]="getSeverity(agendamento.status)"></p-tag>
                  </td>
                  <td>
                    <button pButton icon="pi pi-eye" class="p-button-rounded p-button-text"
                      pTooltip="Ver detalhes"></button>
                    <button pButton icon="pi pi-pencil" class="p-button-rounded p-button-text" pTooltip="Editar"></button>
                    <button pButton icon="pi pi-trash" class="p-button-rounded p-button-text p-button-danger"
                      pTooltip="Cancelar"></button>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </p-tabpanel>
      <p-dialog>
        <!-- ABA: PACIENTES -->
        <p-tabpanel value="Pacientes">
          <div class="tab-content">
            <p-table [value]="patients" [tableStyle]="{'min-width': '60rem'}">
              <ng-template pTemplate="header">
                <tr>
                  <th>Paciente</th>
                  <th>Contato</th>
                  <th>Última Consulta</th>
                  <th>Próxima Consulta</th>
                  <th>Ações</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-patient>
                <tr>
                  <td>
                    <strong>{{ patient.name }}</strong>
                    <br>
                    <small class="text-muted">ID: {{ patient.id }}</small>
                  </td>
                  <td>
                    {{ patient.phone }}
                    <br>
                    <small class="text-muted">{{ patient.email }}</small>
                  </td>
                  <td>
                    {{ patient.lastAppointment | date:'dd/MM/yyyy' }}
                  </td>
                  <td>
                    @if (patient.nextAppointment) {
                    <span class="next-agendamento">
                      {{ patient.nextAppointment | date:'dd/MM/yyyy' }}
                    </span>
                    } @else {
                    <span class="no-agendamento">
                      Sem agendamento
                    </span>
                    }
                  </td>
                  <td>
                    <button pButton icon="pi pi-datepicker-plus" class="p-button-rounded p-button-text"
                      pTooltip="Agendar consulta"></button>
                    <button pButton icon="pi pi-eye" class="p-button-rounded p-button-text"
                      pTooltip="Ver prontuário"></button>
                    <button pButton icon="pi pi-phone" class="p-button-rounded p-button-text"
                      pTooltip="Contatar"></button>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </p-tabpanel>
  </p-tabs>

  <!-- Dialog para Novo Agendamento -->
  <p-dialog header="Novo Agendamento" [style]="{width: '500px'}" [(visible)]="visible" [modal]="true">

    @if (dialogType === 'newAgendamento') {
    <div class="dialog-content">
      <div class="form-group">
        <label>Paciente</label>
        <p-select [options]="patients" [(ngModel)]="newAgendamento.patientId" optionLabel="name" optionValue="id"
          placeholder="Selecione o paciente">
        </p-select>
      </div>

      <div class="form-group">
        <label>Data</label>
        <p-datepicker [(ngModel)]="newAgendamento.date" [showIcon]="true" dateFormat="dd/mm/yy">
        </p-datepicker>
      </div>

      <div class="form-group">
        <label>Hora</label>
        <input pInputText type="time" [(ngModel)]="newAgendamento.time" />
      </div>

      <div class="form-group">
        <label>Tipo de Consulta</label>
        <p-select [options]="appointmentTypes" [(ngModel)]="newAgendamento.type" optionLabel="label" optionValue="value"
          placeholder="Selecione o tipo">
        </p-select>
      </div>

      <div class="form-group">
        <label>Médico</label>
        <p-select [options]="doctors" [(ngModel)]="newAgendamento.doctor" optionLabel="label" optionValue="value"
          placeholder="Selecione o médico">
        </p-select>
      </div>

      <div class="form-group">
        <label>Observações</label>
        <textarea pInputTextarea [(ngModel)]="newAgendamento.notes" rows="3"></textarea>
      </div>
    </div>
    }

    <ng-template pTemplate="footer">
      <button pButton label="Cancelar" icon="pi pi-times" (click)="visible = false" class="p-button-text"></button>
      <button pButton label="Salvar" icon="pi pi-check" (click)="saveAgendamento()"></button>
    </ng-template>
  </p-dialog>
</div>